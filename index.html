<!DOCTYPE html>

<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for HTML5 (experimental) for Linux https://github.com/w3c/tidy-html5/tree/c63cc39">
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8">
  <meta charset="utf-8">

  <title>BlueButton+ Pull API, Dynamic Registration and Push
  Authorization</title>
  <meta name="viewport" content=
  "width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content=""><!-- Le styles -->
  <link href="assets/css/bootstrap.css" rel="stylesheet">
  <link href="assets/css/bootstrap-responsive.css" rel=
  "stylesheet">
  <link href="assets/css/docs.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/gh-fork-ribbon.css">
  <!--[if IE]>
        <link rel="stylesheet" href="assets/css/gh-fork-ribbon.ie.css" />
    <![endif]-->
  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body data-spy="scroll" data-target=".bs-docs-sidebar"
data-twttr-rendered="true">
  <div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
      <a href=
      "https://github.com/blue-button/blue-button-plus-pull">Fork
      me on GitHub</a>
    </div>
  </div><!-- Navbar
      ================================================== -->
  <!-- Subhead
      ================================================== -->

  <header class="jumbotron subhead" id="overview">
    <div class="container">
      <h1>BlueButton+ Pull API</h1>

      <p class="lead">OAuth2 API for RESTful access to patient data
      and bootstrapping DIRECT-based information exchange</p>
    </div>
  </header>

  <div class="container">
    <!-- Docs nav
        ================================================== -->

    <div class="row">
      <div class="span3 bs-docs-sidebar">
        <ul class="nav nav-list bs-docs-sidenav" data-offset-top=
        "200">
          <li>
            <a href="#registration"><i class=
            "icon-chevron-right"></i> App Registration <span class=
            "label section label-success">Common</span></a>
          </li>

          <li class="sidenav-indent">
            <a href="#registration-open"><i class=
            "icon-chevron-right"></i> Open Registration</a>
          </li>

          <li class="sidenav-indent">
            <a href="#registration-trusted"><i class=
            "icon-chevron-right"></i> Trusted Registration</a>
          </li>

          <li>
            <a href="#authorization"><i class=
            "icon-chevron-right"></i> App Authorization
            <span class="label section label-info">Pull</span></a>
          </li>

          <li class="sidenav-indent">
            <a href="#authorization-code"><i class=
            "icon-chevron-right"></i> Authorization Code Grant</a>
          </li>

          <li class="sidenav-indent">
            <a href="#authorization-implicit"><i class=
            "icon-chevron-right"></i> Implicit Grant</a>
          </li>

          <li>
            <a href="#clinical-api"><i class="icon-chevron-right"></i>
            Clinical Data API <span class=
            "label section label-info">Pull</span> </a>
          </li>

          <li class="sidenav-indent">
            <a href="#clinical-summary"><i class=
            "icon-chevron-right"></i> Clinical Summary</a>
          </li>

          <li class="sidenav-indent">
            <a href="#clinical-search"><i class=
            "icon-chevron-right"></i> Document Search</a>
          </li>


          <li class="sidenav-indent">
            <a href="#clinical-document-retrieval"><i class=
            "icon-chevron-right"></i> Document Retrieval</a>
          </li>

          <li>
            <a href="#discovery"><i class="icon-chevron-right"></i>
            Endpoint Discovery <span class=
            "label section label-success">Common</span></a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-trustbundle"><i class=
            "icon-chevron-right"></i> BB+ Trust Bundle</a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-providers"><i class=
            "icon-chevron-right"></i> BB+ Providers</a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-apps"><i class=
            "icon-chevron-right"></i> BB+ Apps</a>
          </li>

          <li>
            <a href="#push-authorization"><i class=
            "icon-chevron-right"></i> Push Authorization
            <span class=
            "label section label-warning">Push</span></a>
          </li>
        </ul>
      </div>

      <div class="span7">
        <section id="explanation">
          <div class="well alert-info">
            <strong>Note:</strong> This page documents
            specifications applicable to both BB+ <span class=
            "label section label-warning">Push</span> (Direct email
            transport) and BB+ <span class=
            "label section label-info">Pull</span> (HTTP RESTful
            transport) protocols. It is the goal of this proposal
            to re-use <span class=
            "label section label-success">Common</span> components
            for Push and Pull apps. In this way, a system
            implementing both would be able to re-use the same code
            and patterns for common activities such as end-user
            authorization, dynamic client registration, and service
            discovery.
          </div>
        </section>

        <section id="registration">
          <div class="page-header">
            <h1>App Registration <small>up-front,
            partially-automated</small> <span class=
            "label label-success">Common</span></h1>

            <p>Before an app connects to a BlueButton+ provider, it
            registers with that provider as an OAuth2 Client. The
            registration process informs the provider what the app
            is called, where to find it, what permissions it might
            ask patients for, and how to display an authorization
            screen to patients.</p>

            <p>BB+ apps register with providers using <a href=
            "http://tools.ietf.org/html/draft-ietf-oauth-dyn-reg">OAuth2
            Dynamic Client Registration</a>. This guide walks
            through the process of registering a client using open
            registration, as well as an example of using trusted
            registration which leverages trust bundles.</p>

            <h2 id="registration-open">Open
            Registration</h2>BlueButton+ providers offer an open
            registration option. To register, an app issues an
            <code>https POST</code> to the registration endpoint,
            supplying registration parameters as a JSON object.

            <div class="well alert-info">
              <strong>Note</strong>: Open registration is
              appropriate for new and experimental apps, but
              patient-facing authorization screens should display a
              warning indicating that an app's identity has not
              been verified. To provide a higher level of
              assurance, apps can perform a Trusted Registration
              (described below).
            </div>
<div class=wsd wsd_style="napkin"><pre>
Title: BlueButton+ Open Registration Process
participant App
participant Provider 

App-&gt;Provider: Registration Request (no JWT)
Provider--&gt;App: client_id + secret + registration token
            </pre></div>

            <h3 id="registration-parameters">Registration
            Parameters</h3>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Type</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>client_name</code></td>

                <td><code>string</code></td>

                <td>Human-readable name of the Client to be
                presented to the user.</td>
              </tr>

              <tr>
                <td><code>client_uri</code></td>

                <td><code>string</code></td>

                <td>URL of the homepage of the Client.</td>
              </tr>

              <tr>
                <td><code>logo_uri</code></td>

                <td><code>string</code></td>

                <td>URL that references a logo for the Client. If
                present, the server SHOULD display this image to
                the end user during approval</td>
              </tr>

              <tr>
                <td><code>tos_uri</code></td>

                <td><code>string</code></td>

                <td>URL that points to a human-readable Terms of
                Service for the Client. The Authorization Server
                SHOULD display this URL to the End-User if it is
                given.</td>
              </tr>

              <tr>
                <td><code>redirect_uris</code></td>

                <td><code>array</code></td>

                <td>Array of redirect URIs for use in the
                Authorization Code and Implicit grant types. An
                Authorization Server SHOULD require registration of
                valid redirect URIs for all clients that use these
                grant types in order to protect against token and
                credential theft attacks.</td>
              </tr>

              <tr>
                <td><code>response_types</code></td>

                <td><code>array</code></td>

                <td>
                  Array of the OAuth 2.0 response types that the
                  Client may use.

                  <ul>
                    <li>public clients: <code>"token"</code> or
                    <code>"code"</code></li>

                    <li>confidential clients:
                    <code>"code"</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>token_endpoint_auth_method</code></td>

                <td><code>string</code></td>

                <td>
                  The requested authentication type for the Token
                  Endpoint.

                  <ul>
                    <li>public clients: <code>"none"</code></li>

                    <li>confidential clients:
                    <code>"client_secret_basic"</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>grant_types</code></td>

                <td><code>array</code></td>

                <td>
                  Array of OAuth 2.0 grant types that the Client
                  may use.

                  <ul>
                    <li>public clients: <code>["implicit"]</code>
                    or <code>["authorization_code"]</code></li>

                    <li>confidential clients:
                    <code>["authorization_code"]</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td><code>string</code></td>

                <td>Space separated list of scope values (as
                described in OAuth 2.0 Section 3.3 [RFC6749]) that
                the client is declaring that it may use when
                requesting access tokens. A valid BB+ scope must
                include <code>single-patient</code>, and may
                additionally include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>contacts</code></td>

                <td><code>array</code></td>

                <td>Array of email addresses for people responsible
                for this Client. The Authorization Server MAY make
                these addresses available to end users for support
                requests for the Client. An Authorization Server
                MAY use these email addresses as identifiers for an
                administrative page for this client.</td>
              </tr>
            </table>

            <h3>Example Registration for a Public Client</h3>
            <pre class="prettyprint">
POST /register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: bbplus-provider.org

{
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["token"],
  "grant_types": ["implicit"],
  "token_endpoint_auth_method": "none",
  "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

            <h3>Example Registration for a Confidential Client</h3>
            <pre class="prettyprint">
POST /register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: bbplus-provider.org

{
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["code"],
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "client_secret_basic",
  "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

            <p>The client will receive a unique
            <code>client_id</code> for that service provider, and
            will also receive a
            <code>registration_access_token</code> that it can use
            to maintain its registration there, as described in
            OAuth Dynamic Client Registration.</p>

            <h2 id="registration-trusted">Trusted Registration</h2>

            <p>In addition to open registration, BlueButton+
            providers support a Trusted Registration option. When
            performing a Trusted Registration, apps follow the
            protocol described above, with the addition of a bearer
            token from a Trust Bundle that the provder trusts. This
            trusted bearer token is a <a href=
            "http://tools.ietf.org/html/draft-ietf-oauth-json-web-token">
            JSON Web Token</a> signed with <a href=
            "http://tools.ietf.org/html/draft-jones-json-web-signature">
            JSON Web Signature</a> and is verifiable by the service
            provider.</p>

            <div class="well alert-info">
              <h4>Background: Client Classes and Client
              Instances</h4>

              <p>BB+ expects that most apps will connect to
              <em>multiple BB+ providers</em>, and many apps will
              run directly from <em>multiple end-user devices</em>.
              This specification balances a desire for fine-grained
              app registration (e.g. auditing each device's access
              history independently) with a need for
              coarser-grained permissions (e.g. disabling a rogue
              app across all providers, or all devices). We achieve
              this balance by enabling two points of control:
              <em>Client Classes</em> and <em>Client
              Instances</em>.</p>

              <p>As an example to illustrate this distinction,
              let's consider an iOS-based Blood Pressure Grapher.
              This app is considered a "Client Class" because it's
              associated with a single author, homepage, logo,
              Terms of Service agreement, etc. As we'll describe
              below, this class has instances for each BB+ Provider
              the Blood Pressure Grapher registers with, and
              possibly for each device it runs on.</p>

              <p><strong>Client Instances per-Provider</strong> In
              the OAuth sense, the BP Grapher app has a separate
              "instance" for each (app, provider) pair it
              participates in. For example, it may use a separate
              <code>client_id</code> to communicate with each BB+
              provider. (Since <code>client_id</code> is assigned
              by each provider as part of the normal OAuth Dynamic
              Registration process, apps generally <em>will</em>
              have have distinct identifiers for each provider.)
              Still, since these instances all represent "the same
              app", they belong to the same <strong>Client
              Class</strong>.</p>

              <p><strong>Client Instances per-Device</strong>
              Similarly, if the Blood Pressure Grapher is installed
              on multiple iOS devices, it may be assigned a
              separate <code>client_id</code> for each
              (app-on-device, provider) pair it participates in.
              (Since <code>client_id</code> is assigned by each
              provider as part of the normal OAuth Dynamic
              Registration process, apps <em>may be assigned</em>
              distinct identifiers per-device by each provider.)
              Again, since these instances all represent "the same
              app," they belong to the same <strong>Client
              Class</strong>.</p>

              <p><strong>Instance- and Class-level
              Controls</strong> In this way, BB+ Providers are free
              to assign each instance of a Client Class a different
              <code>client_id</code>, or to assign the same
              <code>client_id</code> to all Client Instances of a
              given class, in accordance with local policy. Apps
              simply use the identifiers assigned. No matter how
              identifiers are assigned, BB+ Providers maintain the
              ability to make decisions at the Class level, so if
              the Blood Pressure Grapher loses trust, all of its
              instances can be disabled in one fell swoop.</p>
            </div>

            <h3>Process overview:</h3>
<div class=wsd wsd_style="napkin"><pre>
Title: BlueButton+ Trusted Registration Process
participant Provider 
participant Trust bundle
participant App

App->Trust bundle: Register for bundle membership
Trust bundle-->Trust bundle: Verify app claims
Trust bundle-->App: Signed Registration JWT
App->App: Time passes...
App->Trust bundle: Lookup provider
Trust bundle-->App: Provider URI
App->Provider: Registration Request + JWT
Provider->Trust bundle: Lookup app claims
Trust bundle-->Provider: App claims
Provider->Provider: Verify reg matches claims
Provider-->App: client_id, secret, registration token
</pre></div>

                
            <pre class="diagram">
</pre>

            <ol>
              <li>Client Class is manually pre-registered with a
              Trust Bundle.

                <ul>
                  <li>Trust Bundle collects any fixed app
                    <a href="#registration-parameters">registration
                    parameters</a> including, at a minimum,
                    <code>client_name</code> and
                    <code>client_uri</code>
                  </li>

                  <li>Trust Bundle verifies these parameters
                  (according to bundle-specific policy)</li>

                  <li>Trust Bundle makes these parameters
                  discoverable via <a href="#discovery-apps">BB+
                  App Discovery</a>
                  </li>

                  <li>Trust Bundle supplies the Client Class with a
                  pre-registration token (signed JWT) for
                  subsequent dynamic registration operations</li>
                </ul>
              </li>

              <li>Client Instance presents the pre-registration
              token (using an Authorization header or any valid
              mechanism from RFC6750) to the registration endpoint
              of the service provider (which is discoverable via
              the <a href="#discovery-providers">BB+ Provider
              Discovery</a>.
              </li>

              <li>Service provider validates the pre-registration
              token by checking the signature against the public
              key of the trust bundle indicated by the
              <code>iss</code> field of the token (?and/or doing
              token introspection from the <code>iss</code>).</li>

              <li>Service provider does application discovery based
              on the <code>iss</code> and <code>sub</code> fields
              of the token to find the apps.json entry for this
              application</li>

              <li>Service provider compares any dynamically registered client
              metadata fields to any fixed value fields discovered in apps.json
              <span class="label section label-info">TODO
              string-comparison and validation rules</span></li>

              <li>Client Instance receives a <code>client_id</code>
              and <code>client_secret</code> as well as a
              <code>registration_access_token</code></li>

              <li>Client Instance requests user authorization and
              tokens</li>

              <li>Client Instance accesses protected services at
              service provider</li>
            </ol>
            <p>

            <h3>Pre-registration</h3>

            <p>First, the Client class is manually pre-registered
            with a Trust Bundle. This process may fix any of the
            client parameters listed above, such as the
            <code>client_name</code> and
            <code>redirect_uris</code>. At a minimum,
            <code>client_name</code> and <code>client_uri</code>
            must be fixed at pre-registration time. All classes of
            a client will share any fixed parameters.</p>

            <p>The pre-registered client class will receive:</p>

            <ul>
              <li>a "subject" identifier unique within the scope of
              the trust bundle. This "subject" identifer
              <strong>should</strong> be the same as the app's
              homepage (<code>client_uri</code>).</li>

              <li>a signed registration token with the following
              properties:</li>

              <li style="list-style: none; display: inline">
                <ul>
                  <li><code>iss</code>: issuer is the URL of the
                  trust bundle provider</li>

                  <li><code>sub</code>: subject is an identifier
                  from the trust bundle (as described above)</li>

                  <li><code>iat</code>: timestamp of when this
                  pre-registration information was last updated
                  (and this token was issued)</li>

                  <li><code>exp</code>: optional timestamp of when
                  this pre-registration token is no longer
                  valid</li>

                  <li><em>these claims are combined in a JWT
                  asymmetrically signed by the trust bundle. The
                  signature can be validated from the trust
                  bundle's published public key (published as a
                  JWK). <span class="label section label-info">TODO
                  add detail</span> .</em></li>
                </ul>
              </li>
            </ul>

            <p>All service providers within a trust bundle must be
            able to validate the signature and validity of any
            registration tokens. It's recommended (required?) that
            trust bundle providers publish a <a href=
            "http://tools.ietf.org/html/draft-richer-oauth-introspection">
            token introspection endpoint</a> to facilitate this.
            <span class="label section label-info">TODO add
            detail</span>.</p>

            <h3>Registration</h3>

            <p>The registration token from the previous step is
            used by instances of the client during the initial call
            to the registration endpoint for each service provider.
            The service provider does <a href="#discovery-apps">BB+
            App Discovery</a> based on the subject and issuer in
            the registration token to determine which client
            metadata fields have been set ahead of time by the
            pre-registration process. The Service provider will
            compare these pre-registered fields with any
            dynamically provided fields and determine the validity
            of the registration.</p>

            <h3>Notes</h3>

            <div class="well alert-info">
              <strong>Notes:</strong>

              <ul>
                <li>The application owner/developer is responsible
                for pre-registering with the trust bundle.</li>

                <li>The service provider is responsible for
                matching dynamic registration claims with the
                pre-registered claims.</li>

                <li>Client Instances present the token that comes
                from the pre-registration process as part of a
                normal dynamic registration with a particular
                service provider.</li>

                <li>This technique allows service providers to link
                together multiple instances of a client based on
                the tokens used during registration. Service
                providers are responsible for linking thse client
                instances together if they so desire. A service
                provider MAY re-use the same client_id for all
                instance, or it may issue different client_ids for
                each instance.</li>

                <li>Clients are responsible (in all registration
                cases) for accepting and using the client_id issued
                to them by each service provider when talking to
                that service provider.</li>

                <li>Even a web-server style client is going to need
                to get different client_id's from every service
                provider, which means that even a single
                installation of a client could have multiple
                "instances" as far as the network is
                concerned.</li>
              </ul>
            </div>
          </div>
        </section>

        <section id="authorization">
          <div class="page-header">
            <h1>App Authorization <small>a runtime, patient-driven
            step</small> <span class=
            "label label-info">Pull</span></h1>

            <p>BlueButton+ providers allow apps to obtain patient
            authorization to health data using standard OAuth2
            authorization flows. There are two authorization flows
            initially supported: Implcit Grant (appropriate only
            for public clients) and Authorization Code Grant
            (appropriate for public as well as confidential
            clients).</p>

            <p>Both flows follow the same basic pattern:</p>

            <ol>
              <li>App redirects the browser to a BlueButton+
              Provider's Authorization endpoint</li>

              <li>BB+ Provider authenticates patient and obtains
              authorization</li>

              <li>BB+ Provider redirects control back to App</li>
            </ol>

            <h2 id="authorization-code">Authorization Code Grant
            <small>for public or confidential clients</small></h2>

            <h3>1. App-to-Provider Redirection</h3>To initiate an
            Authorization Code Grant authorization, the app
            redirects the browser to a BlueButton+ provider's
            Authorization endpoint with the following URL
            parmeters:

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>response_type</code></td>

                <td>REQUIRED. Value MUST be set to
                <code>code</code>.</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED. The client identifier</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQUIRED. Must match one of the client's
                pre-registered redirect URIs.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Must include
                <code>single-patient</code>, and may additionally
                include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>RECOMMENDED. An opaque value used by the client
                to maintain state between the request and callback.
                The authorization server includes this value when
                redirecting the user-agent back to the client. The
                parameter SHOULD be used for preventing cross-site
                request forgery <span class=
                "label label-warning">Should state be REQUIRED with
                a minimum level of entropy?</span></td>
              </tr>
            </table>

            <h5>Example App-to-Provider Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/authorize?
response_type=code&amp;
client_id=bp-grapher&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org
</pre>

            <h3>2. Provider Authenticates Patient and Obtains
            Authorization</h3>The mechanism by which providers
            authenticate patients and obtain authorization is out
            of scope for this specification

            <h3>3. Provider-to-App Redirection</h3>

            <p>After a successful authorization step, the
            BlueButton+ provider redirects the browser to the app's
            <code>redirect_uri</code>, with the following
            parameters <strong>supplied in the query
            component</strong>.</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>code</code></td>

                <td>REQUIRED. The authorization code generated by
                the authorization server. The authorization code
                MUST expire shortly after it is issued to mitigate
                the risk of leaks.</td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>REQUIRED. The exact value received from the
                client.</td>
              </tr>
            </table>

            <h5>Example Provider-to-App Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/after-oauth?
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
state=98wrghuwuogerg97

Host: bpgrapher.org
</pre>

            <h3>4. App exchanges authorization code for access
            token</h3>

            <p>After receiving an authorization code, the app
            issues a request to the BlueButton+ provider's
            <code>Token URI</code> to exchange the authorization
            code for an access token. The exchange includes the
            following parameters</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>grant_type</code></td>

                <td>REQUIRED. Fixed value:
                <code>authorization_code</code></td>
              </tr>

              <tr>
                <td><code>code</code></td>

                <td>REQUIRED. Code that an app can exchange for an
                access token.</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQIRED. The same redirect_uri used in the
                initial authorization request</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED for public clients. May be omitted by
                confidential clients.</td>
              </tr>
            </table>

            <h5>Example Code-for-Token Exchange Request (Public
            Client)</h5>
            <pre class="prettyprint">
POST /token HTTP/1.1
Host: server.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
client_id=bp-grapher 
</pre>

            <h5>Example Code-for-Token Exchange Request
            (Confidential Client)</h5>
            <pre class="prettyprint">
POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic {{TODO: client password auth example}}
Content-Type: application/x-www-form-urlencoded/token?

grant_type=authorization_code&amp;
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth 
</pre>

            <p>The response is a JSON object containing the
            following parameters</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>access_token</code></td>

                <td>REQUIRED. The access token issued by the
                authorization server</td>
              </tr>

              <tr>
                <td><code>token_type</code></td>

                <td>REQUIRED. Fixed value: <code>bearer</code></td>
              </tr>

              <tr>
                <td><code>expires_in</code></td>

                <td>REQUIRED. The lifetime in seconds of the access
                token. For example, the value "3600" denotes that
                the access token will expire in one hour from the
                time the response was generated.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Scope of access authorized by the
                patient.</td>
              </tr>
            </table>

            <h5>Example Code-for-Token Exchange Response</h5>
            <pre class="prettyprint">
{
  "access_token": "i8hweunweunweofiwweoijewiwe",
  "token_type": "bearer",
  "expires_in": "3600",
  "scope": "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

            <h2 id="authorization-implicit">Implicit Grant
            <small>for public clients</small></h2>

            <h3>1. App-to-Provider Redirection</h3>To initiate an
            Implicit Grant authorization, the app redirects the
            browser to a BlueButton+ provider's Authorization
            endpoint with the following URL parmeters:

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>response_type</code></td>

                <td>REQUIRED. Value MUST be set to
                <code>token</code>.</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED. The client identifier</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQUIRED. Must match one of the client's
                pre-registered redirect URIs.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Must include
                <code>single-patient</code>, and may additionally
                include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>RECOMMENDED. An opaque value used by the client
                to maintain state between the request and callback.
                The authorization server includes this value when
                redirecting the user-agent back to the client. The
                parameter SHOULD be used for preventing cross-site
                request forgery <span class=
                "label label-warning">Should state be REQUIRED with
                a minimum level of entropy?</span></td>
              </tr>
            </table>

            <h5>Example App-to-Provider Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/authorize?
response_type=token&amp;
client_id=bp-grapher&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org 
</pre>

            <h3>2. Provider Authenticates Patient and Obtains
            Authorization</h3>The mechanism by which providers
            authenticate patients and obtain authorization is out
            of scope for this specification

            <h3>3. Provider-to-App Redirection</h3>

            <p>After a successful authorization step, the
            BlueButton+ provider redirects the browser to the app's
            <code>redirect_uri</code>, with the following
            parameters <strong>embedded in the URI's #fragment
            component</strong>.</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>access_token</code></td>

                <td>REQUIRED. The access token issued by the
                authorization server</td>
              </tr>

              <tr>
                <td><code>token_type</code></td>

                <td>REQUIRED. Fixed value: <code>bearer</code></td>
              </tr>

              <tr>
                <td><code>expires_in</code></td>

                <td>REQUIRED. The lifetime in seconds of the access
                token. For example, the value "3600" denotes that
                the access token will expire in one hour from the
                time the response was generated.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Scope of access authorized by the
                patient.</td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>REQUIRED. The exact value received from the
                client.</td>
              </tr>
            </table>

            <h5>Example Provider-to-App Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/after-auth#
access_token=i8hweunweunweofiwweoijewiwe&amp;
token_type=bearer&amp;
expires_in=3600&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org 
</pre>
          </div>
        </section>

        <section id="clinical-api">
          <div class="page-header">

            <h1>Clinical API<small>summary & search</small> <span class=
            "label label-info">Pull</span></h1>

            <h2>Using the BB+ Clinical API</h2>
            To access BlueButton+ Clinical API endpoints, an app:
            <ol>
            <li>Obtains Patient Authorization via <a href="#authorization">BB+ Authorization</a></li>
            <li>Discovers a provider's clinical API endpoints via <a href="#discovery-single-provider">Single-Provider Discovery</a> <span class=
            "label section label-info">TODO</span></li>
            <li>Issues an authenticatd request to the endpoint, supplying its OAuth bearer token</li>
            </ol>

            <h3>Discovering endpoint URIs</h3>

            Each BB+ Provider exposes a clinical summary endpoing and a
            document search endpoint.  An app discovers the URLs for these
            endpoints at runtime by performing <a
            href="#discovery-single-provider">Single-Provider Discovery</a> <span class=
            "label section label-info">TODO</span>.
            The discovery process results in a JSON-LD object whose <code>bb_api.*</code>
            properties are used for the operations described below.

            <h3>Issuing API calls</h3>

            To issue an authenticated API call, an app requests the BB+
            Clinical API endpoint using the appropriate HTTP method (generally
            <code>GET</code> for read-only operations), including its OAuth
            bearer token using an <code>Authorization</code> header or ay valid
            mechanism from RFC6750.

            <h3>Negotiating <code>Content-type</code> of the response</h3>

           An app may include an <code>Accept</code> HTTP header with the
           request.  Apps that are unable to set an <code>Accept</code> header
           may alternatively supply a <code>_format</code> query parameter.
           Valid <code>content-type</code> values are listed for each endpoint below.

            <h2 id="clinical-summary">Clinical Summary</h2>

            <h5>Endpoint URI: <code>bb_api</code>.<code>summary</code></h5>

            The clinical summary endpoint returns the most recently available
            summary document.  By default, BB+ Providers supply a clinical
            summary document in Consolidated CDA XML format.  For convenience,
            other MIME types may be derived from a Consolidated CDA and
            returned to an app.  Providers SHOULD support the following
            formats, all of which can be automatically derived from a C-CDA:

            <table class="table table-striped">

              <tr>
                <th><nobr>Accept header</th>
                <th>description</th>
              </tr>

              <tr>
                <td><code>text/xml</code></td>
                <td>DEFAULT.  A Consolidated CDA in XML.</td>
              </tr>

              <tr>
                <td><code>text/plain</code></td>
                <td>A document rendered as a simple text file (as in the VA's "classic" BlueButton implementation.</td>
              </tr>

              <tr>
                <td><code>text/html</code></td>
                <td>A document rendered as HTML (as might be obtained by applying a generic stylesheet to a C-CDA).</td>
              </tr>

            </table>

            <h3>Using the summary endpoint</h3>

            <p>To retrieve the most recent clinical summary document, an app
            issues an http <code>GET</code> to the <code>summary</code>
            endpoint, including its bearer token using an Authorization
            header or any valid mechanism from RFC6750.
            </p>

        
            <h4>Example</h4>
    
            <pre>
GET /bb/records/me/summary HTTP/1.1
Accept: application/xml
Authorization: i8hweunweunweofiwweoijewiwe
Host: bbplus-provider.org
</pre>

            <h2 id="clinical-search">Document Search</h2>

            <h5>Endpoint URI: <code>bb_api</code>.<code>search</code></h5>
      
            <p>The clinical document search endpoint allows an app to search for
            clinical documents that match a set of search parameters. A core
            set of features are described here.  For full details, see <a
            href="http://www.hl7.org/implement/standards/fhir/xdsentry.htm">FHIR's
            XdsEntry definition</a>.  
            </p>

            <h3>Search returns a feed of XdsEntry document descriptors</h3>
            
            It's important to keep in mind that the document search endpoint
            does not return document content directly.  Rather, it returns an
            Atom feed (or JSON equivalent) containing document descriptors in
            the form of FHIR's XdsEntry resources.  These resources included
            basic document metadata as well as a URL that can be used to fetch
            a document's contents (see <a href="#api-document-fetch">Document
            Retrieval</a> below.)


            <h5>Search Parameters</h5>
            <table class="table table-striped">

              <tr>
                <th>Query parameter</th>
                <th>Description</th>
              </tr>

              <tr>

                <td><code>mimeType</code></td>

                <td>
                <p>Filter the available documents by MIME type. For example, this
                parameter can be used to limit search results to XML documents
                (<code>text/xml</code>), or PDFs
                (<code>application/pdf</code>). </p>
                <p>Multiple <code>mimeType</code> parameters are processed as an "or" (union).</p>
                </td>
              </tr>

              <tr>
                <td><code>format</code></td>

                <td>
                
                Filter the available documents by information model.  For example, the <code>text/xml</code> MIME type is used for CCR, CCD 1.0, and CCDA documents.  The following values are supported:

                 <dl class="dl-horizontal">
                  <dt>CCR</dt>
                  <dd>Content formatted using the <a href="http://www.astm.org/Standards/E2369.htm">ASTM CCR</a> Standard</dd>

                  <dt>CCD</dt>
                  <dd>Content formatted using the <a href="http://www.hl7.org/implement/standards/product_brief.cfm?product_id=6">HL7 CCD 1.0</a> Standard</dd>

                  <dt>CCDA</dt>
                  <dd>Content formatted using the <a href="http://www.hl7.org/implement/standards/product_brief.cfm?product_id=258">HL7 CCDA</a> Standard (including CCD 1.1)</dd>
                </dl>
                
                Multiple <code>format</code> parameters are processed as an "or" (union).

                </td>

              </tr>

              <tr>
                <td><code>class</code></td>

                <td>
                
                Filter the available documents by document class model.  The following values are supported:
                 <dl class="dl-horizontal">

                  <dt>Summary</dt>
                  <dd>Clinical summary document</dd>

                  <dt>HandP</dt>
                  <dd>History and Physical</dd>

                  <dt>Consult</dt>
                  <dd>Consult document</dd>

                  <dt>Discharge</dt>
                  <dd>Hospital discharge summary</dd>

                  <dt>Operative</dt>
                  <dd>Operative note</dd>

                  <dt>Procedure</dt>
                  <dd>Procedure note</dd>

                  <dt>Progress</dt>
                  <dd>Progress note</dd>

                  <dt>Imaging</dt>
                  <dd>Imaging report</dd>

                  <dt>Lab</dt>
                  <dd>Lab report</dd>

                  <dt>Unstructured</dt>
                  <dd>Unstructured document</dd>
                </dl>
                Multiple <code>format</code> parameters are processed as an "or" (union).

               </td>

              </tr>

              <tr>
                <td><code>service.start-after</code></td>

                <td>
                
                <p>Filter the available documents for encounters beginning
                after a given time. If no time zone is specified, the server
                may assume local time, local time of the querying system, or
                some other fixed time zone.</p>

                <p><strong>Example</strong>: <code>2012-01-01T06:00-05:00</code> (6:00am on January 1, 2012 GMT-5)</p>
              
                </td>
              </tr>

              <tr>
                <td><code>service.start-before</code></td>

                <td>
                
                <p>Filter the available documents for encounters beginning
                before a given time. </p>

                </td>
              </tr>

              <tr>
                <td><code>service.stop-after</code></td>

                <td>
                <p>Filter the available documents for encounters ending
                after a given time. </p>
                </td>
              </tr>

              <tr>
                <td><code>service.stop-before</code></td>

                <td>
                <p>Filter the available documents for encounters ending
                before a given time. </p>
                </td>
              </tr>

              <tr>
                <td><code>created-before</code></td>

                <td>
                <p>Filter for documents authored before a given time. </p>
                </td>
              </tr>

              <tr>
                <td><code>created-after</code></td>

                <td>
                <p>Filter for documents authored after a given time. </p>
                </td>
              </tr>

          </table>

          In addition to the search paramters described above, BB+ providers
          support Content-type negotiation to determine the format in which
          results are returned. The following formats are available:

            <table class="table table-striped">
              <tr>
                <th>Accept header</th>
                <th>description</th>
              </tr>

              <tr>
                <td><code>application/atom+xml</code></td>
                <td>DEFAULT. An Atom feed representation of <code>XdsEntry</code> elements.
              </tr>

              <tr>
                <td><code>application/json</code></td>
                <td>A JSON bundle of <code>XdsEntry</code> elements (like Atom, but in FHIR-defined JSON)</td>
              </tr>

            </table>

 
          <div class="well alert-info">
            <h4>Content-type vs. mimeType vs. format</h4>

            Three distinct "format-related" parameters are used at the clinical document search endpoint, and it's important to keep them straight.

            <dl>
            <dt>Accept header (or _format parameter)</dt>
            <dd>Defines the MIME type in which search results are returned.  Remember that search results are returned as a feed of XdsEntry document descriptions, and actual document content is not embedded in this feed. So this parameter simply determines whether the feed is Atom (default) or JSON.</dd>
            <dt>mimeType parameter</dt>
            <dd>Search parameter to filter documents by MIME type</dd>
            <dt>format parameter</dt>
            <dd>Search parameter to filter documents by format (for example, CCR vs. CCD vs. CCDA). Note the lack of undescore.</dd>
            </dl>
          </div>

          <h3>Using the search endpoint</h3>

            <p>To search for relevant documents, an app
            issues an http <code>GET</code> to the <code>search</code>
            endpoint, including its bearer token using an Authorization
            header or any valid mechanism from RFC6750.
            </p>

        
          <h4>Example request</h4>

          <p>The following query obtains a JSON feed of C-CDA Operative notes and
          Procedure notes pertaining to episodes of care that ended prior to
          2013.</p>
          
          <p>Newlines and indentation added around URL parameters for
          clarity</p>

          <pre>
GET /bb/records/me/search?                      # provider-supplied endpoint
   mimeType=text%2Fxml&amp;                         # limit to XML documents
   format=CCDA&amp;                                 # limit to Consolidated CDAs *or*
   format=CCD&amp;                                  #          CCD 1.0 documents
   class=Operative&amp;                             # limit to Operative notes *or*
   class=Procedure&amp;                             #          Procedure notes
   service.end-before=2013-01-01T00:00Z         # limit to pre-2013 services
   HTTP/1.1
Accept: application/json                        # return a JSON feed (rather than Atom XML)
Authorization: i8hweunweunweofiwweoijewiwe
Host: bbplus-provider.org
</pre>
          <h4 id="example-xdsentry-feed">Example response</h4>
          <div class="well alert-info">

            <p><strong>Note</strong>:  FHIR's <code>XdsEntry</code> document
            descriptor includes a lot more metadata than BB+ may need for the
            document search endpoint.  FHIR defines many of these fields
            (including patientId) as required.  The representation below is
            simplified somewhat.</p>

            <p>In practice, to retrieve actual document contents, app
            developers will want to examine the <code>.entry</code> array of
            the search result, and for each <code>XdsEntry</code> in that
            array, the <code>url</code>.<code>value</code> can be extracted and
            dereferenced.  For more details, see <a
            href="api-document-fetch">Document Retrieval</a>.

          </div>

          <pre>
{
  "title": "Search results for resource type XdsEntry",
  "id": "urn:uuid:b66d1181-a951-410a-bad5-538c20456b",
  "updated": "2013-04-06T00:08:45Z",
  "entry": [
    {
      "title": "XdsEntry Document",
      "id": "http://bbplus-provider.org/bb/records/me/xdsentry/@830fcde0-5d03-4305-8589-a4fa8d574d0e",
      "updated": "2013-03-04T17:15:00Z",
      "category": [
        {
          "scheme": "http://hl7.org/fhir/resource-types",
          "term": "XdsEntry"
        }
      ],
      "content": {
        "XdsEntry": {
          "url": {
            "value": "http://bbplus-provider.org/bb/records/me/xdsentry/@830fcde0-5d03-4305-8589-a4fa8d574d0e/document"
          },
          "mimeType": {
            "value": "text/xml"
          },
          "format": {
            "system": {
              "value": "http://ihe.net/xds/connectathon/formatCodes"
            },
            "code": {
              "value": "CCDA"
            },
            "display": {
              "value": "Consolidated CDA"
            }
          },
          "class": {
            "system": {
              "value": "http://ihe.net/xds/connectathon/classCodes"
            },
            "code": {
              "value": "HandP"
            },
            "display": {
              "value": "History and Physical"
            }
          },
          "created": {
            "value": "2005-12-24T09:35:00+11:00"
          }
        }
      }
    }
  ]
}
          </pre>

            <h2 id="clinical-document-retrieval">Document Retrieval</h2>

            <h5>Endpoint URI: this endpoint is document-specific</h5>
            <h3>Retrieving an individual document</h3>

            <p> By performing a <a href="#clinical-search">Document Search</a>,
            an app obtains an Atom feed (or JSON equivalent) of
            <code>XdsEntry</code> document descriptors.  To fetch actual
            document contents, the app issues an authenticated,  HTTPS
            <code>GET</code> to dereference the document URI.  This URI is
            available in the <code>./url/@value</code> xpath for an Atom entry,
            or the <code>url</code>.<code>value</code> field of a JSON feed
            entry. </p>

      
          <h4>Example request</h4>
          For the example <a href="#example-xdsentry-feed">JSON feed above</a>, an app would fetch actual document contents via:
          <pre>
GET /bb/records/me/xdsentry/@830fcde0-5d03-4305-8589-a4fa8d574d0e/document HTTP/1.1
Authorization: i8hweunweunweofiwweoijewiwe
Host: bbplus-provider.org
</pre>
 
        </div>
      </section>

        <section id="discovery">
          <div class="page-header">
            <h1>Provider and App Discovery <small>via Trust Bundle
            Servers</small> <span class=
            "label label-success">Common</span></h1>

            <p>BlueButton+ Pull uses <strong>Trust Bundle
            Servers</strong> to enable discovery of BB+ Providers
            and BB+ Apps. Each Trust Bundle Server exposes a set of
            trusted providers and a set of trusted apps at
            well-known <code>https</code> URLs, using simple
            <a href="http://json-ld.org/">JSON-LD</a> arrays. In
            the BB+ ecosystem, apps and providers must be
            pre-configured with a Trust Bundle Server (or Servers).
            All discovery endpoints are organized beneath
            <code>.well-known/bb/</code> at the server's root.</p>

            <h5>Why JSON-LD?</h5>

            <div class="well alert-info">
              <p><strong>JSON-LD</strong> provides a nice balance
              between idiomatic JSON and well-structured data
              representations. By combining a JSON payload with a
              JSON-LD context, properties can be expanded to full
              URIs so that data can be mixed and matched with other
              services. For example, the BB+ Provider element below
              can automatically be:</p>

              <ul>
                <li>
                  <a href="http://tinyurl.com/bpz5xsx" target=
                  "_blank">Expanded to full property URIs</a>
                </li>

                <li>
                  <a href="http://tinyurl.com/cp9vmum" target=
                  "_blank">Normalized in RDF</a>
                </li>
              </ul>
            </div>

            <h2 id="discovery-trustbundle">Trust Bundle
            Discovery</h2>

            <p>A Trust Bundle Server exposes a BB+ Trust Bundle
            discovery endpoint at:
            <code>/.well-known/bb/trustbundle.json</code></p>

            <h3>trustbundle.json</h3>

            <p><code>trustbundle.json</code> is a single
            TrustBundle element expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>

            <p>While any vocabulary from schema.org may be used in
            describing a trust bundle, the <strong>following fields
            are required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Human-readable Name of the Trust Bundle</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Root URL of the Trust Bundle</td>
              </tr>

              <tr>
                <td><code>jwks_uri</code></td>

                <td>URL to the JSON Web Key (JWK) set for this
                trust bundle</td>
              </tr>

              <tr>
                <td><code>oauth2</code></td>

                <td>Collection of OAuth2 endpoints</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>introspect</code></td>

                <td>
                  RECOMMENDED OAuth2 introspection endpoint (As
                  described in <a href=
                  "http://tools.ietf.org/html/draft-richer-oauth-introspection">
                  this draft</a>)
                </td>
              </tr>
            </table>

            <h5>trustbundle.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://jmandel.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "name": "The Trust Bundle Foundation",
  "url": "http://trustbundle.org/",
  "jwks_uri": "https://trustbundle.org/public_key.jwks",
  "oauth2": {
    "introspect": "https://trustbundle.org/oauth/introspect",
  }

}
            
</pre>

            <h2 id="discovery-providers">Provider Discovery</h2>

            <p>A Trust Bundle Server exposes a BB+ Provider
            Discovery endpoint at:
            <code>/.well-known/bb/providers.json</code></p>

            <h3>providers.json</h3>

            <p><code>providers.json</code> is a JSON array of
            Provider elements, expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>

            <p>While any vocabulary from schema.org may be used in
            describing a provider, the <strong>following fields are
            required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Name of the BB+ Data Provider organization</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Primary url of the provider organization</td>
              </tr>

              <tr>
                <td><code>patient_signin</code></td>

                <td>URL where a patient can sign in to the
                Provider</td>
              </tr>

              <tr>
                <td><code>oauth2</code></td>

                <td>Collection of OAuth2 endpoints</td>
              </tr>

              <tr>
                <td class="subproperty"><code>authorize</code></td>

                <td>OAuth2 authorization endpoint</td>
              </tr>

              <tr>
                <td class="subproperty"><code>token</code></td>

                <td>OAuth2 token endpoint</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>introspect</code></td>

                <td>
                  OAuth2 introspection endpoint (As described in
                  <a href=
                  "http://tools.ietf.org/html/draft-richer-oauth-introspection">
                  this draft</a>)
                </td>
              </tr>

              <tr>
                <td><code>bb_api</code></td>

                <td>Collection of BB+ API endpoints</td>
              </tr>

              <tr>
                <td class="subproperty"><code>summary</code></td>

                <td>BlueButton+ Clinical Summary endpoint</td>
              </tr>

              <tr>
                <td class="subproperty"><code>search</code></td>

                <td>BlueButton+ Document Search endpoint</td>
              </tr>
            </table>

            <h5>providers.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://blue-button.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

[
{
  "name": "Good Health Clinic",
  "description": "Serving your health needs since 1999",
  "url": "http://goodhealthclinic.org",
  "patient_signin": "http://portal.goodhealthclinic.org",
  "location": {
    "geo": {                       
      "latitude": 42.3591,            # just making the point that we can
      "longitude": -71.0934           # use arbitrary schema.org properties
    }
  },
  "oauth2": {
    "authorize_uri": "http://portal.goodhealthclinic.org/authorize",
    "token_uri": "http://portal.goodhealthclinic.org/token"
  },
  "bb_api": {
    "summary": "http://api.goodhealthclinic.org/patient/documents/summary",
    "search": "http://api.goodhealthclinic.org/patient/documents/search"
  }
},
{
 ... (more providers here) ...
}
] 
</pre>

            <h2 id="discovery-apps">App Discovery</h2>

            <p>A Trust Bundle Server exposes a <strong>BB+ App
            Discovery</strong> endpoint at:
            <code>/.well-known/bb/apps.json</code></p>

            <h3>apps.json</h3>

            <p><code>apps.json</code> is a JSON array of App
            elements, expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>

            <p>While any vocabulary from schema.org may be used in
            describing a provider, the <strong>following fields are
            required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Name of the BB+ App</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Primary url of the provider organization</td>
              </tr>

              <tr>
                <td><code>fixed_registration_parameters</code></td>

                <td>
                  JSON structure containing any <a href=
                  "#registration-parameters">registration
                  parameters</a> that are fixed across all
                  instances of this app. A Trusted Registration
                  request that fails to match (NOTE: need matching
                  mechanisms defined here) on any parameters
                  included here will be rejected. This may contain
                  any valid client metadata reistration parameters,
                  and it is RECOMMENDED that the following ones be
                  particularly locked down.
                </td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>client_name</code></td>

                <td>client_name must be fixed across all app
                instances and must match the schema.org name
                above</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>client_uri</code></td>

                <td>client_uri must be fixed across all app
                instances and must match the schema.org url
                above</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>redirect_uris</code></td>

                <td>the set of allowable redirect_uris must be
                fixed across all app instances</td>
              </tr>
            </table>

            <h5>apps.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://blue-button.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

[
{
  "url": "https://bpgrapher.org",
  "name": "Blood Pressure Grapher",
  "fixed_registration_parameters": {
      "client_name": "Blood Pressure Grapher",
      "client_uri": "https://bpgrapher.org",
      "logo_uri": "http://bpgrapher.org/images/logo.png",
      "contacts": [
        "plot-master@bpgrapher.org"
      ],
      "tos_uri": "https://bpgrapher.org/tos",
      "redirect_uris": [
        "https://bpgrapher.org/after-auth"
      ],
      "response_types": ["token"],
      "grant_types": ["implicit"],
      "token_endpoint_auth_method": "none",
      "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
  },
},
{
 ... (more apps here) ...
}
] 
</pre>
          </div>
        </section>

        <section id="push-authorization">
          <div class="page-header">
            <h1>Push Authorization <span class=
            "label label-warning">Push</span></h1>

            <p>Patient data is stored with many providers, and
            manually requesting an update from each provider can be
            difficult for a patient. The following workflow enables
            BB+ Pull apps to offer patient an easy-to-use
            OAuth2-based mechanism for creating a BB+ Push
            connection. In orther words, this workflow helps user
            find providers and register for BB+ Push updates
            (Direct e-mail messaging).</p>

            <div class="well alert">
              <p>In this example, assume the user is interacting
              with this environment:</p>

              <dl>
                <dt>Client</dt>

                <dd>BP-Grapher</dd>

                <dt>Service Provider</dt>

                <dd>Good Health Clinic</dd>

                <dt>Scope</dt>

                <dd><code>send-email-to</code> is a special,
                structured scope that is used to indicate the
                DIRECT email to send information to for this
                user</dd>
              </dl>
              <p>
            </div>

            <h3>User Authorization Flow:</h3>

            <p>In this section, we describe how a user can
            authorize a service provider to send updates them
            updates as new health data becomes available. To enable
            this process, the client must perform the following
            steps:</p>

            <ol>
              <li>Discovery as described above (<a href=
              "#discovery-providers">provider discovery</a> at its
              trust bundle).
              </li>

              <li>Search, filter, and optionally cache discovered
              service providers. The user will select one or more
              to authorize.</li>

              <li>
                <a href="#registration-trusted">Dynamically
                register</a> if the client doesn't already have
                their OAuth 2 credentials for the chosen service
                provider.
              </li>

              <li>Send the user (in a web browser) to the service
              provider's authorization endpoint. They have the
              option to authorize this provider to push their
              data.</li>

              <li>Verify success by requesting a token from the
              service provider's token endpoint to ensure the
              user's selection succeeded.</li>
            </ol>
            <p>

            <h4>1. Discovery</h4>

            <p>Discovery for Push is the same process as shown
            above for <a href="#discovery-providers">provider
            discovery</a>. A provider's information, including
            endpoint URIs, will be served in the following
            format:</p>
            <pre class="prettyprint">
{
  "name": "Good Health Clinic",
  "description": "Serving your health needs since 1999",
  "url": "http://goodhealthclinic.org",
  "patient_signin": "http://portal.goodhealthclinic.org",
  "location": {
    "geo": {                       
      "latitude": 42.3591,            # just making the point that we can
      "longitude": -71.0934           # use arbitrary schema.org properties
    }
  },
  "oauth2": {
    "authorize_uri": "http://portal.goodhealthclinic.org/authorize",
    "token_uri": "http://portal.goodhealthclinic.org/token"
  },
  "bb_api": {
    "summary": "http://api.goodhealthclinic.org/patient/documents/summary",
    "search": "http://api.goodhealthclinic.org/patient/documents/search"
  }
}
</pre>

            <h4>2. Search, filter, and cache</h4>

            <p>The specifics of client-side searching, filtering,
            caching, and selecting are out of scope for this guide.
            Part of the rationale for delegating this task to the
            client is that the implementation of these tasks may
            vary by platform</p>

            <h4>3. Dynamic registration</h4>

            <p>Dynamic registration for Push is the same process as
            <a href="#registration-trusted">shown above</a>. This
            step retrieves a client_id and client_secret for this
            specific service provider. These values may and likely
            will vary across providers. If the client has already
            retrieved the client's ID and secret, this step can be
            skipped. Below is an example of the metadata sent in a
            request for dynamic registration and the response
            received.</p>

            <p>Dynamic registration request:</p>
            <pre class="prettyprint">
{
  "url": "https://bpgrapher.org",
  "name": "Blood Pressure Grapher",
  "fixed_registration_parameters": {
    "client_name": "Blood Pressure Grapher",
    "client_uri": "https://bpgrapher.org",
    "logo_uri": "http://bpgrapher.org/images/logo.png",
    "contacts": [
      "plot-master@bpgrapher.org"
    ],
    "tos_uri": "https://bpgrapher.org/tos",
    "redirect_uris": [
      "https://bpgrapher.org/after-auth"
    ],
    "response_types": ["code"],
    "grant_types": ["authorization_code"],
    "token_endpoint_auth_method": "none",
    "scope":  "send-email-to"
  },
}
</pre>

            <p>Dynamic registration response:</p>
            <pre class="prettyprint">
{
  "client_id": "bp-grapher-goodhealth",
  "client_secret": "aser98uw4ijhsdfg9r4",
  "registration_access_token": "2398askljasdf.gjo23r98adsf.asdf8923uwekljashdf7892334",
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["code"],
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "none",
  "scope":  "send-email-to"
}
</pre>

            <h4>4. Authorization request</h4>

            <p>By this step, the client has its OAuth 2
            credentials. The client will use that data to send the
            user to the service provider's authorization endpoint.
            Below is an example authorization request for the code
            workflow (more information is available in OAuth 2 RFC
            6749 Section 4.1):</p>
            <pre class="prettyprint">
http://portal.goodhealthclinic.org/authorize?
  response_type=code&amp;
  client_id=bp-grapher-goodhealth&amp;
  redirect_uri=https://bpgrapher.org/after-auth&amp;
  state=aliawejhwiluaq34hiuow&amp;
  scope=send_email_to:oip8erjoiaewjoi@direct.bp-grapher.org
</pre>

            <div class="well alert">
              <p><strong>Note:</strong> The send_email_to scope
              construct above is asking for permission to send
              e-mail to the given address after the :, using a
              simple expression language as part of the structured
              scope.</p>
            </div>

            <p>At this point, the client will receive either a
            positive response or a failure. Hypothetically, this
            response reflects the ultimate results, but the next
            step addresses the client's ability to verify this
            response</p>

            <p>Positive response: Client is redirected to:</p>
            <pre class="prettyprint">
https://bpgrapher.org/after-auth?
  state=aliawejhwiluaq34hiuow&amp;
  code=oafea8i23n
</pre>

            <p>Error response: (e.g. user clicked deny):</p>
            <pre class="prettyprint">
https://bpgrapher.org/after-auth?
  state=aliawejhwiluaq34hiuow&amp;
  error=access_denied (Other error codes are available from 4.1.2.1)
</pre>

            <h4>5. Verify authorization results</h4>

            <p>To verify that the code we got is real, we request a
            token using the code from the token endpoint. If this
            returns an access token (and not an error), then we
            know the code we used was good and that the user
            actually aubbthorized for us. Optionally, the client
            can also check the scope of the returned token to
            ensure that the requested scopes were received. Below
            is an example of the request for this verification:</p>
            <pre class="prettyprint">
http://portal.goodhealthclinic.org/token
  client_id=bp-grapher-goodhealth&amp;
  client_secret=aser98uw4ijhsdfg9r4&amp;
  redirect_uri=https://bpgrapher.org/after-auth&amp;
  grant_type=code&amp;
  code=oafea8i23n
</pre>

            <p>The server then returns the token structure as
            follows:</p>
            <pre class="prettyprint">
{
  "access_token": "i8hweunweunweofiwweoijewiwe",
  "token_type": "bearer",
  "expires_in": "3600",
  "scope": "send_email_to:oip8erjoiaewjoi@direct.bp-grapher.org"
} 
</pre>
          </div>

          <div class="well alert-info">
            <h3>Alternative Push Authorization Strategy
            <span class="label label-warning">Push</span></h3>An
            alternative to this whole approach would be to have the
            Client be Good Health Clinic and the Provider be
            BP-Grapher, with the protected data being the email
            address to send things to. This is more in line with
            OAuth's REST-friendly model and the traditional
            definition of roles, but it doesn't fit as well with
            the PUSH methods we're trying to enable here.
          </div>
        </section>
      </div>
    </div>
  </div><!-- Footer
        ================================================== -->

  <footer class="footer">
    <div class="container">
      <p>Automate Blue Button Initiative 2013</p>
    </div>
  </footer><!-- Le javascript
        ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="./assets/js/jquery.js">
</script> <script src="./assets/js/bootstrap-transition.js">
</script> <script src="./assets/js/bootstrap-alert.js">
</script> <script src="./assets/js/bootstrap-modal.js">
</script> <script src="./assets/js/bootstrap-dropdown.js">
</script> <script src="./assets/js/bootstrap-tab.js">
</script> <script src="./assets/js/bootstrap-tooltip.js">
</script> <script src="./assets/js/bootstrap-popover.js">
</script> <script src="./assets/js/bootstrap-button.js">
</script> <script src="./assets/js/bootstrap-collapse.js">
</script> <script src="./assets/js/bootstrap-affix.js">
</script> <script src="./assets/js/bootstrap-scrollspy.js">
</script> <script src="./assets/js/bootstrap-carousel.js">
</script> <script src="./assets/js/bootstrap-typeahead.js">
</script> <script src="./assets/js/holder.js">
</script> <script src="./assets/js/prettify.js">
</script> <script src="./assets/js/application.js">
</script>
<script type="text/javascript" src="http://www.websequencediagrams.com/service.js"></script>
</body>
</html>
